# Microsoft 2FA / SSO Implementation Plan

This plan outlines the steps to enable "Microsoft 2FA" for the CoreComm platform. This can be interpreted in two ways, both of which are covered here:
1.  **Microsoft SSO (Azure AD)**: Allowing users to sign in with their Microsoft accounts (which often enforce 2FA at the organization level).
2.  **Microsoft Authenticator (TOTP)**: Ensuring the existing 2FA implementation works seamlessly with the Microsoft Authenticator app.

## 1. Microsoft SSO (Azure AD) Implementation

To allow users to sign in with Microsoft, we need to configure the Azure provider in Supabase and update the login UI.

### Step 1: Azure Portal Registration
1.  Go to the [Azure Portal](https://portal.azure.com/).
2.  Navigate to **Microsoft Entra ID** (formerly Azure Active Directory).
3.  Select **App registrations** > **New registration**.
4.  **Name**: `CoreComm Platform` (or your app name).
5.  **Supported account types**:
    - *Accounts in this organizational directory only* (Single Tenant) - if internal only.
    - *Accounts in any organizational directory* (Multitenant) - for SaaS apps.
6.  **Redirect URI**: Select **Web** and enter your Supabase callback URL:
    - `https://<your-project-ref>.supabase.co/auth/v1/callback`
7.  Click **Register**.

### Step 2: Get Credentials
1.  Copy the **Application (client) ID**.
2.  Go to **Certificates & secrets** > **New client secret**.
3.  Create a secret and copy the **Value** (not the ID).

### Step 3: Supabase Configuration
1.  Go to your Supabase Dashboard > **Authentication** > **Providers**.
2.  Enable **Azure (Microsoft)**.
3.  Enter the **Client ID** and **Client Secret** from the previous step.
4.  (Optional) Enter the **Tenant URL** if restricting to a specific organization.
5.  Click **Save**.

### Step 4: Frontend Implementation
Update `app/auth/login/page.tsx` to include a "Sign in with Microsoft" button.

```tsx
// Add this handler
const handleMicrosoftLogin = async () => {
  setLoading(true)
  setError(null)

  try {
    const { error } = await supabase.auth.signInWithOAuth({
      provider: "azure",
      options: {
        redirectTo: `${window.location.origin}/auth/callback`,
        scopes: 'email profile openid', // Standard scopes
      },
    })

    if (error) {
      setError(error.message)
    }
  } catch (err) {
    setError("An unexpected error occurred")
  } finally {
    setLoading(false)
  }
}

// Add the button in the UI (near the Google button)
<Button 
  variant="outline" 
  type="button" 
  disabled={loading} 
  onClick={handleMicrosoftLogin}
  className="w-full"
>
  {loading ? (
    <LoadingSpinner size="sm" className="mr-2" />
  ) : (
    <svg className="mr-2 h-4 w-4" viewBox="0 0 23 23">
      <path fill="#f35325" d="M1 1h10v10H1z"/>
      <path fill="#81bc06" d="M12 1h10v10H12z"/>
      <path fill="#05a6f0" d="M1 12h10v10H1z"/>
      <path fill="#ffba08" d="M12 12h10v10H12z"/>
    </svg>
  )}
  Sign in with Microsoft
</Button>
```

## 2. Microsoft Authenticator (TOTP) Support

The current MFA implementation (`components/mfa-enrollment.tsx`) uses standard TOTP, which is fully compatible with Microsoft Authenticator.

### Verification Steps
1.  Go to **Security Settings** in the app.
2.  Click **Enable 2FA**.
3.  When the QR code appears:
    - Open **Microsoft Authenticator** on your phone.
    - Tap **+** > **Other (Google, Facebook, etc.)**.
    - Scan the QR code.
4.  Enter the code generated by the app.

### UI Improvements (Optional)
To make this clearer for users, we can update the text in `components/mfa-enrollment.tsx`:

**Current:**
> "Scan the QR code with your authenticator app (like Google Authenticator or Authy)"

**Proposed:**
> "Scan the QR code with your authenticator app (like **Microsoft Authenticator**, Google Authenticator, or Authy)"

## 3. Enforcement Policy Update

If you want to *enforce* Microsoft 2FA specifically, you should rely on the Azure AD configuration.

1.  **Azure AD Conditional Access**: Configure policies in Azure AD to require MFA for all users signing into the "CoreComm Platform" enterprise application.
2.  **Supabase Enforcement**: In your application code, you can check the `amr` (Authentication Methods References) claim in the session to see if MFA was performed, but relying on the IdP (Azure) to enforce it is usually safer for SSO.

## Next Steps
1.  [ ] Register app in Azure Portal.
2.  [ ] Configure Supabase Provider.
3.  [ ] Update Login Page UI.
4.  [ ] Update MFA Enrollment text.
